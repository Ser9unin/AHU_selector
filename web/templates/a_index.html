<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <link rel="stylesheet" src="static/styles.css">
        <script defer src = "javascript/scripts.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function(){
              const sendForm = document.getElementById('AHU_list');
              const result = document.getElementById('AUU_list');

              sendForm.addEventListener('submit', (event) => {
                var T1data = document.querySelectorAll('input[name="T1"]');
                var T2data = document.querySelectorAll('input[name="T2"]');

                event.preventDefault();

                //check if T1 > T2, if not we can't calculate our unit.
                for (let i = 0; i < T1data.length; i++){
                  if (T1data[i].value < T2data[i].value){
                    alert('T1 не может быть меньше T2');
                    T1data[i].focus();                    
                    return false;
                  }
                }

                //run AJAX request and rerened only result of calculation
                 
                var ajreq = new XMLHttpRequest();
                const myform = new URLSearchParams(new FormData(sendForm)).toString()

                console.log(myform);
              
                  ajreq.onreadystatechange = function () {
                    if (ajreq.readyState === 4 && ajreq.status === 200) {
                      var data = JSON.parse(ajreq.responseText);
                      result.innerHTML = "";
                      renderHTML(data);
                    }
                  }

                  ajreq.open("POST", '/get_AHU', true);
                  ajreq.send(myform);

                  function renderHTML(data) {
                    var htmlFullString = "";
                    var htmlPartString = "";

                    for (i = 0; i < data.length; i++) {
                        htmlPartString += "<tr>" + 
                          "<td>" + data[i].Unit_ID + "</td>"
                          + "<td>" + data[i].Code + "</td>"
                          + "<td>" + data[i].DN + "</td>"
                          + "<td>" + data[i].Pump + "</td>"
                          + "<td>" + data[i].Pump_setting + "</td>"
                          + "<td>" + data[i].AQT_setting + "</td>"
                          + "<td>" + data[i].Static_valve + "</td>"
                          + "<td>" + data[i].Static_valve_setting + "</td>"
                          + "</tr>"
                    }
                    htmlFullString += '<table id="AUU_units"><tr><th>Название узла</th><th>Кодовый номер</th><th>DN</th><th>Тип насоса</th>'
                          + '<th>Настройка насоса</th><th>Настройка AQT-R</th><th>Тип РБК</th><th>Настройка РБК</th></tr>'
                          + htmlPartString
                          + '</table>'
                    result.insertAdjacentHTML('beforeend', htmlFullString);
                  }
              })
            });
        </script>
        <title>index</title>
    </head>
    <body>
      <nav class="navbar navbar-expand-lg bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="index.html">AHU Select</a>
              <div class="navbar-nav">
                  <a class="nav-link" href="#">Об узлах</a>
              </div>
          </div>
      </nav>
      <div>
          <form action="/">
              <label for="login">Login</label>
              <input type="text" name="abc" id="login" placeholder="login">

              <label for="password">Password</label>
              <input type="password" name="xyz" id="password" placeholder="password">
              
              <input type="submit">
          </form>
      </div>
        <div class="container">
          <form id="AHU_list" enctype="application/x-www-form-urlencoded">
            <table class="AHU_units">
              <tr>
                <th>Название</br>установки</th>
                <th>Нагрузка Q, кВт</th>
                <th>Температура</br>подачи T1,</br>гр C</th>
                <th>Температура</br>обратки T2,</br>гр C</th>
                <th>Потери давления</br>в вентустановке dP,</br> м. вод. ст.</th>
                <th>Сторона</br>подключения</br>(от источника)</th>
                <th>Удалить установку</th>
              </tr>
              <tr name="Single_AHU">
                <td><input type="text" name="AHU_name"/></td>
                <td><input type="number" name="Load" min = 0 value="1000" required/></td>
                <td><input type="number" name="T1" min = 20 max = 130 value="95" required/></td>
                <td><input type="number" name="T2" min = 20 max = 130 value="70" required/></td>
                <td><input type="number" name="dPahu" min = 0 value="10" required/></td>
                <td><select type="text" name="Connection_side">
                <option value="left">Левый</option>
                <option value="right">Правый</option>
                </td>
              </tr>
            </table>
            <div class="common_buttons">
                <input class="addAHU" type="button" id="addAHU" value="Добавить"/>
                <input class="control_button" type="submit" value="Рассчитать">
            </div>
          </form>
        </div>
        <div class="container" id="AUU_list" ></div>
          <script>
            /*const form = document.getElementById('AHU_list');
            const result = document.getElementById('AUU_list');

            form.addEventListener('submit', function(event){
              event.preventDefault();
              var ajreq = new XMLHttpRequest();
              const myform = new URLSearchParams(new FormData(form)).toString()

              console.log(myform);
              
              ajreq.onreadystatechange = function () {
                if (ajreq.readyState === 4 && ajreq.status === 200) {
                  var data = JSON.parse(ajreq.responseText);
                  result.innerHTML = "";
                  renderHTML(data);
                }
              }

              ajreq.open("POST", '/get_AHU', true);
              ajreq.send(myform)
            })

            function renderHTML(data) {
              var htmlFullString = "";
              var htmlPartString = "";

              for (i = 0; i < data.length; i++) {
                  htmlPartString += "<tr>" + 
                    "<td>" + data[i].Unit_ID + "</td>"
                    + "<td>" + data[i].Code + "</td>"
                    + "<td>" + data[i].DN + "</td>"
                    + "<td>" + data[i].Pump + "</td>"
                    + "<td>" + data[i].Pump_setting + "</td>"
                    + "<td>" + data[i].AQT_setting + "</td>"
                    + "<td>" + data[i].Static_valve + "</td>"
                    + "<td>" + data[i].Static_valve_setting + "</td>"
                    + "</tr>"
              }
              htmlFullString += '<table id="AUU_units"><tr><th>Название узла</th><th>Кодовый номер</th><th>DN</th><th>Тип насоса</th>'
                    + '<th>Настройка насоса</th><th>Настройка AQT-R</th><th>Тип РБК</th><th>Настройка РБК</th></tr>'
                    + htmlPartString
                    + '</table>'
              result.insertAdjacentHTML('beforeend', htmlFullString);
            }*/
          </script>

  </body>
</html>
